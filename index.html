<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap: Theme slate, Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cerulean/bootstrap.min.css"
        integrity="sha384-3fdgwJw17Bi87e1QQ4fsLn4rUFqWw//KU0g8TvV6quvahISRewev6/EocKNuJmEw" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD" crossorigin="anonymous">
</head>

<body class="bg-dark justify-content-center">

    <!-- Main Card -->
    <form class="p-3 col-12 col-md-8 col-lg-6 mx-auto">

        <!-- First Section -->
        <article class="card bg-light section-height mb-3 px-3 py-2" style="border-radius:5%; min-height: auto;">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Side: Text Content -->
                <div>
                    <h3 class="mt-3 text-primary-emphasis">Today's Conditions</h3>
                    <h4 id="hdrType" class="m-2 text-primary-emphasis">Overall:</h4>
                    <h4 id="hdrTemp" class="m-2 text-primary-emphasis">
                        <i class="bi bi-thermometer text-danger" alt="thermostat for temperature"></i>
                    </h4>
                </div>
                <!-- Right Side: Weather Icon -->
                <div class="ms-auto text-end" style="width: 100px;">
                    <i id="imgCurrentWeather" class="card-img-top" style="font-size:80px;" alt="Weather icon"></i>
                </div>
            </div>
        </article>

        <!-- Second Section -->
        <article class="card bg-light flex-fill section-height mb-3 px-3 py-2"
            style="border-radius:5%; min-height: auto;">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Side: Text Content -->
                <div>
                    <h4 id="hdrWindSpeed" class="m-2 text-primary-emphasis">Wind Speed:</h4>
                    <h4 id="hdrHumidity" class="m-2 text-primary-emphasis">Humidity:</h4>
                </div>
                <!-- Right Side: Wind Icon -->
                <div class="ms-auto text-end" style="width: 100px;">
                    <i id="imgCurrentWind" class="card-img-top" style="font-size:80px;"
                        alt="current wind type icon"></i>
                </div>
            </div>
        </article>

        <!-- Third Section: Location -->
        <article class="card bg-light section-height mb-3 px-3 py-2" style="border-radius:5%; min-height: auto;">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Side: Text Content -->
                <div>
                    <button id="btnGetLocation" >Get Location</button>
                    <h5 id="hdrAddress" class="mt-3 text-primary">Location Name</h5>
                    <p id="demo" class="m-2"></p>
                </div>
                <!-- Right Side: Location Icon -->
                <div class="ms-auto text-end" style="width: 100px;">
                    <i id="imgAdditional" class="card-img-top" style="font-size:80px;" alt="Additional icon"></i>
                </div>
            </div>
        </article>

    </form>

    <!-- Footer -->
    <footer class="text-center py-3">
        <p class="text-primary">Data courtesy of <a href="https://open-meteo.com/en/docs"
                style="text-decoration-line: underline;">Open Meteo</a></p>
    </footer>

    <script>         const key = "AIzaSyDqIDKm8thRmlpdB9R4GK1AmABlXcBeiEc"
    // Your Weather API URL (this should be dynamically adjusted as needed)
    const strURL = "https://api.open-meteo.com/v1/forecast?latitude=36.1628&longitude=-85.5016&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=America%2FChicago";
    let strLocationURL = "";
    let objGoogleAPIReturn = "";   

    document.querySelector("#btnGetLocation").addEventListener("click", function(){
        event.preventDefault()
        getLocation()
    })

    // City location printed to html
    function locationToHTML(){

    }
    //************************************** // CONDENSE THIS INTO ONE FUNCTION **************************************************
    // NEXT FEATURE IS UPDATING LOCATION EVERY FIVE MINUTES 
    async function fetchGoogleAPI(strLocationURL) {
        if (sessionStorage.getItem("lastAddress") !== null) {
            console.log("lastAddress exists:", sessionStorage.getItem("lastAddress"));
            return sessionStorage.getItem("lastAddress");
        } else {
            try {
                console.log("Attempting Pull...")
                const objResponse = await fetch(strLocationURL);  // Wait for fetch response
                if (!objResponse.ok) throw new Error(`HTTP error! Status: ${objResponse.status}`);
                const objData = await objResponse.json();  // Wait for JSON conversion

                let objCachedAddress = objData.results?.[0]?.formatted_address || "Address not found";

                // Store the address in sessionStorage for future use
                sessionStorage.setItem("lastAddress", objCachedAddress);

                return objCachedAddress;
            } catch (error) {
                console.error("Error fetching data:", error);
                return null;
            }
        }
    }
    // Geolocation
    async function showPosition(position) {
        // Display the coordinates on the webpage
        sessionStorage.setItem("lastTimestamp", Date.now());

        document.querySelector("#demo").innerHTML =
            "Latitude: " + position.coords.latitude +
            "<br>Longitude: " + position.coords.longitude;

        // Create an object with coordinates
        const objCoordinates = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
        };

        // Log the object (for debugging)
        console.log("Storing coordinates:", objCoordinates);

        // Store in sessionStorage as a JSON string
        sessionStorage.setItem("lastCoords", JSON.stringify(objCoordinates));

        // Ensure 'key' is defined
        if (typeof key === "undefined") {
            console.error("Google Maps API key is not defined.");
            return;
        }

        // Construct Google Maps API request URL
        const strLocationURL = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${position.coords.latitude},${position.coords.longitude}&key=${key}`;

        // DEBUG
        console.log(position);
        console.log(strLocationURL);

        try {
            // Fetch address using Google API
            const address = await fetchGoogleAPI(strLocationURL);

            if (address) {
                document.querySelector("#hdrAddress").innerHTML = address;
            } else {
                document.querySelector("#hdrAddress").innerHTML = "Address not found.";
            }
        } catch (error) {
            console.error("Error fetching address:", error);
            document.querySelector("#hdrAddress").innerHTML = "Error retrieving address.";
        }
    }




    function getLocation() { // starting point for finding location on button press

        // Retrieve the last stored timestamp from sessionStorage
        const lastTimestamp = sessionStorage.getItem("lastTimestamp");
        const currentTime = Date.now();

        // Check if the last address and coordinates exist, and if 2 minutes (120,000 milliseconds) or more have passed
        if ((sessionStorage.getItem("lastAddress") !== null && sessionStorage.getItem("lastCoords") !== null) && (lastTimestamp != null || currentTime - lastTimestamp >= 10000)) {

            document.querySelector("#hdrAddress").innerHTML = sessionStorage.getItem("lastAddress");

            // Retrieve and parse the JSON string
            const storedCoords = JSON.parse(sessionStorage.getItem("lastCoords"));
            //console.log(storedCoords);
             document.querySelector("#demo").innerHTML = `Latitude: ${storedCoords.lat}<br>Longitude: ${storedCoords.lon}`;
        }

            else{
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                } else {
                    console.log("fail")
                    document.querySelector("#demo").innerHTML = "Geolocation is not supported by this browser."
                } 
            }
           
        }

       

        function showError(error) {
            console.log("Error code: " + error.code);
            console.log("Error message: " + error.message);
            document.querySelector("#demo").innerHTML = "Geolocation error: " + error.message;
        }


    //********************************************************************************
    async function getWeather() {
        try {
            const objResponse = await fetch(strURL);

            if (!objResponse.ok) {
                throw new Error(`HTTP error status: ${objResponse.status}`);
            }

            const objData = await objResponse.json();

            // Display Temperature
            document.querySelector("#hdrTemp").innerHTML += objData.current.temperature_2m + "Â°F";
            document.querySelector("#hdrTemp").ariaLabel = "Current Temperature of " + objData.current.temperature_2m + " degrees Fahrenheit.";

            // Display Humidity
            document.querySelector("#hdrHumidity").innerHTML = "Humidity: " + objData.current.relative_humidity_2m + '%';
            document.querySelector("#hdrHumidity").ariaLabel = "Humidity is about " + objData.current.relative_humidity_2m + " percent.";

            // Display Wind Speed
            document.querySelector("#hdrWindSpeed").innerHTML = "Wind Speed: " + objData.current.wind_speed_10m + " mph";
            document.querySelector("#hdrWindSpeed").ariaLabel = "Wind Speed of " + objData.current.wind_speed_10m + " miles per hour.";

            // Wind speed indicator
            if (objData.current.wind_speed_10m <= 7) {
                document.querySelector("#imgCurrentWind").className += " bi bi-sun"
            } else if (objData.current.wind_speed_10m > 7 && objData.current.wind_speed_10m < 30) {
                document.querySelector("#imgCurrentWind").className += " bi bi-cloud-haze2"
            } else if (objData.current.wind_speed_10m >= 30) {
                document.querySelector("#imgCurrentWind").className += " bi bi-wind"
            } else {
                document.querySelector("#imgCurrentWind").className += " bi bi-cloud"
            }

            // Display type of precipitation
            let strRainType = objData.current.precipitation;
            if (objData.current.precipitation <= 0.5) {
                strRainType = 'Clear';
            } else if (objData.current.rain > 0.5) {
                strRainType = 'Rain';
            } else if (objData.current.snowfall > 0) {
                strRainType = "Snow";
            } else if (objData.current.showers > 0) {
                strRainType = "Light Rain";
            } else {
                strRainType = "Precipitation";
            }
            document.querySelector("#hdrType").innerHTML += strRainType;

            // Weather icon update based on weather code
            let intWeatherCode = objData.current.weather_code;
            let imgCurrentWeather = document.querySelector("#imgCurrentWeather");

            if (intWeatherCode <= 0) {
                imgCurrentWeather.className = "card-img-top bi bi-sun-fill fs-0";
            } else if (intWeatherCode < 20) {
                imgCurrentWeather.className = "card-img-top bi bi-cloud fs-0";
            } else if (intWeatherCode < 29) {
                imgCurrentWeather.className = "card-img-top bi bi-cloud-fill fs-0";
            } else if (intWeatherCode < 50 || intWeatherCode >= 90) {
                imgCurrentWeather.className = "card-img-top bi bi-cloud-lightning-rain-fill";
            } else if (intWeatherCode < 70) {
                imgCurrentWeather.className = "card-img-top bi bi-cloud-drizzle-fill";
            } else if (intWeatherCode < 80) {
                imgCurrentWeather.className = "card-img-top bi bi-cloud-fill";
            } else {
                imgCurrentWeather.className = "card-img-top bi bi-cloud-fill fs-0";
            }

            return objData;
        } catch (objError) {
            console.error('Error fetching data:', objError);
        }
    }

    // Initialize location and weather on page load
        //getLocation();
        getWeather();
   
    </script>
</body>

</html>